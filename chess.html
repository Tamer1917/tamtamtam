function isValidMove(fromRow, fromCol, toRow, toCol) {
    const piece = initialBoard[fromRow][fromCol];
    const targetPiece = initialBoard[toRow][toCol];

    // التأكد من أن الحركة ليست إلى مربع يحتوي على قطعة من نفس اللون
    if (targetPiece && isPieceOfCurrentPlayer(targetPiece)) {
        return false;
    }

    switch (piece.toLowerCase()) {
        case 'p': // الجندي
            // الجندي يتحرك للأمام بمقدار مربع واحد أو مربعين في حال لم يتحرك بعد
            if (currentPlayer === 'white') {
                if (fromRow === 1 && toRow === fromRow + 2 && fromCol === toCol && !initialBoard[toRow][toCol]) {
                    return true; // حركة أولى للجندي الأبيض
                }
                if (toRow === fromRow + 1 && fromCol === toCol && !targetPiece) {
                    return true; // حركة للأمام لجندي أبيض
                }
                // الهجوم للأمام بزاوية 45 درجة
                if (toRow === fromRow + 1 && (toCol === fromCol - 1 || toCol === fromCol + 1) && targetPiece) {
                    return true; // أخذ الجندي الأبيض
                }
                // تحقق من الأخذ بالتجاوز
                if (toRow === fromRow + 1 && (toCol === fromCol - 1 || toCol === fromCol + 1) && !targetPiece) {
                    if (isEnPassant(fromRow, fromCol, toRow, toCol)) {
                        return true; // الأخذ بالتجاوز
                    }
                }
            } else {
                if (fromRow === 6 && toRow === fromRow - 2 && fromCol === toCol && !initialBoard[toRow][toCol]) {
                    return true; // حركة أولى للجندي الأسود
                }
                if (toRow === fromRow - 1 && fromCol === toCol && !targetPiece) {
                    return true; // حركة للأمام لجندي أسود
                }
                // الهجوم للأمام بزاوية 45 درجة
                if (toRow === fromRow - 1 && (toCol === fromCol - 1 || toCol === fromCol + 1) && targetPiece) {
                    return true; // أخذ الجندي الأسود
                }
                // تحقق من الأخذ بالتجاوز
                if (toRow === fromRow - 1 && (toCol === fromCol - 1 || toCol === fromCol + 1) && !targetPiece) {
                    if (isEnPassant(fromRow, fromCol, toRow, toCol)) {
                        return true; // الأخذ بالتجاوز
                    }
                }
            }
            break;

        case 'r': // القلعة
            // القلعة تتحرك أفقيًا أو عموديًا فقط
            if (fromRow === toRow || fromCol === toCol) {
                // التأكد من عدم وجود قطع في الطريق
                if (isPathClear(fromRow, fromCol, toRow, toCol)) {
                    return true;
                }
            }
            break;

        case 'n': // الحصان
            // الحصان يتحرك على شكل "L"
            const rowDiff = Math.abs(fromRow - toRow);
            const colDiff = Math.abs(fromCol - toCol);
            if ((rowDiff === 2 && colDiff === 1) || (rowDiff === 1 && colDiff === 2)) {
                return true;
            }
            break;

        case 'b': // الفيل
            // الفيل يتحرك قطريًا فقط
            if (Math.abs(fromRow - toRow) === Math.abs(fromCol - toCol)) {
                // التأكد من عدم وجود قطع في الطريق
                if (isPathClear(fromRow, fromCol, toRow, toCol)) {
                    return true;
                }
            }
            break;

        case 'q': // الملكة
            // الملكة تتحرك أفقيًا، عموديًا، أو قطريًا
            if (fromRow === toRow || fromCol === toCol || Math.abs(fromRow - toRow) === Math.abs(fromCol - toCol)) {
                // التأكد من عدم وجود قطع في الطريق
                if (isPathClear(fromRow, fromCol, toRow, toCol)) {
                    return true;
                }
            }
            break;

        case 'k': // الملك
            // الملك يتحرك مربعًا واحدًا في أي اتجاه
            if (Math.abs(fromRow - toRow) <= 1 && Math.abs(fromCol - toCol) <= 1) {
                return true;
            }
            break;

        default:
            return false;
    }
    return false;
}

function isEnPassant(fromRow, fromCol, toRow, toCol) {
    // يجب أن يتحقق من الأخذ بالتجاوز فقط في حالة الجندي الذي لم يتحرك من مكانه الأول
    // يجب أن يكون الجندي المنافس قد تحرك مربعين للأمام
    const direction = (currentPlayer === 'white') ? 1 : -1; // تحديد الاتجاه بناءً على اللاعب الحالي
    if (Math.abs(toRow - fromRow) === direction && Math.abs(fromCol - toCol) === 1) {
        const opponentPawnRow = (currentPlayer === 'white') ? toRow - direction : toRow + direction;
        const opponentPawnCol = toCol;
        if (initialBoard[opponentPawnRow][opponentPawnCol] === (currentPlayer === 'white' ? 'p' : 'P')) {
            return true;
        }
    }
    return false;
}

function isPathClear(fromRow, fromCol, toRow, toCol) {
    // هذه الدالة تتحقق من أن الطريق بين القطعة والهدف خالية من القطع
    const rowStep = (toRow - fromRow) === 0 ? 0 : (toRow - fromRow) > 0 ? 1 : -1;
    const colStep = (toCol - fromCol) === 0 ? 0 : (toCol - fromCol) > 0 ? 1 : -1;

    let currentRow = fromRow + rowStep;
    let currentCol = fromCol + colStep;

    while (currentRow !== toRow || currentCol !== toCol) {
        if (initialBoard[currentRow][currentCol]) {
            return false; // هناك قطعة في الطريق
        }
        currentRow += rowStep;
        currentCol += colStep;
    }
    return true;
}
